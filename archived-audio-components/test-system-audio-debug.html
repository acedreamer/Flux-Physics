<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Audio Debug Test</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #0D0D0D;
            color: #00FFFF;
            padding: 20px;
            margin: 0;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .status {
            background: #1a1a1a;
            border: 1px solid #00FFFF;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .button {
            background: #00FFFF;
            color: #0D0D0D;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-family: inherit;
        }
        .button:hover {
            background: #00CCCC;
        }
        .log {
            background: #000;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 10px;
            height: 400px;
            overflow-y: auto;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .success { color: #00FF00; }
        .error { color: #FF0000; }
        .warning { color: #FFAA00; }
        .info { color: #00FFFF; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ”§ System Audio Debug Test</h1>
        
        <div class="status">
            <h3>Chrome System Audio Diagnostics</h3>
            <p>This will help diagnose why system audio isn't working in Chrome.</p>
            <button class="button" onclick="runDiagnostics()">Run Full Diagnostics</button>
            <button class="button" onclick="testSystemAudio()">Test System Audio</button>
            <button class="button" onclick="testMicrophone()">Test Microphone</button>
            <button class="button" onclick="clearLog()">Clear Log</button>
        </div>

        <div class="status">
            <h3>Diagnostic Results:</h3>
            <div id="diagnosticResults">
                <div>Browser: <span id="browserInfo">Detecting...</span></div>
                <div>HTTPS: <span id="httpsStatus">Checking...</span></div>
                <div>getDisplayMedia: <span id="getDisplayMediaSupport">Checking...</span></div>
                <div>getUserMedia: <span id="getUserMediaSupport">Checking...</span></div>
                <div>Audio Context: <span id="audioContextSupport">Checking...</span></div>
            </div>
        </div>

        <div class="status">
            <h3>Debug Log:</h3>
            <div id="debugLog" class="log">Click "Run Full Diagnostics" to begin...\n</div>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logElement = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : 'ðŸ“';
            logElement.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            document.getElementById('debugLog').textContent = '';
        }

        async function runDiagnostics() {
            log('ðŸ”§ Starting comprehensive system audio diagnostics...', 'info');
            
            // 1. Browser Detection
            const userAgent = navigator.userAgent;
            const isChrome = userAgent.includes('Chrome') && !userAgent.includes('Edg');
            const chromeVersion = isChrome ? userAgent.match(/Chrome\/(\d+)/)?.[1] : null;
            
            document.getElementById('browserInfo').textContent = isChrome ? 
                `Chrome ${chromeVersion}` : 'Not Chrome';
            document.getElementById('browserInfo').className = isChrome ? 'success' : 'error';
            
            log(`ðŸŒ Browser: ${userAgent}`, 'info');
            log(`ðŸŒ Chrome detected: ${isChrome} (version: ${chromeVersion})`, isChrome ? 'success' : 'warning');
            
            // 2. HTTPS Check
            const isHTTPS = location.protocol === 'https:';
            const isLocalhost = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
            const isFile = location.protocol === 'file:';
            
            document.getElementById('httpsStatus').textContent = isHTTPS ? 'Yes' : 
                (isLocalhost ? 'Localhost (OK)' : isFile ? 'File:// (May cause issues)' : 'No (Required)');
            document.getElementById('httpsStatus').className = (isHTTPS || isLocalhost) ? 'success' : 'error';
            
            log(`ðŸ”’ Protocol: ${location.protocol}`, 'info');
            log(`ðŸ”’ Hostname: ${location.hostname}`, 'info');
            log(`ðŸ”’ HTTPS/Localhost: ${isHTTPS || isLocalhost}`, (isHTTPS || isLocalhost) ? 'success' : 'error');
            
            if (isFile) {
                log('âš ï¸ Running from file:// - this may cause permission issues', 'warning');
                log('ðŸ’¡ Try running from a local server (http://localhost) or HTTPS', 'warning');
            }
            
            // 3. API Support Check
            const hasGetDisplayMedia = !!(navigator.mediaDevices && navigator.mediaDevices.getDisplayMedia);
            const hasGetUserMedia = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
            const hasAudioContext = !!(window.AudioContext || window.webkitAudioContext);
            
            document.getElementById('getDisplayMediaSupport').textContent = hasGetDisplayMedia ? 'Supported' : 'Not Supported';
            document.getElementById('getDisplayMediaSupport').className = hasGetDisplayMedia ? 'success' : 'error';
            
            document.getElementById('getUserMediaSupport').textContent = hasGetUserMedia ? 'Supported' : 'Not Supported';
            document.getElementById('getUserMediaSupport').className = hasGetUserMedia ? 'success' : 'error';
            
            document.getElementById('audioContextSupport').textContent = hasAudioContext ? 'Supported' : 'Not Supported';
            document.getElementById('audioContextSupport').className = hasAudioContext ? 'success' : 'error';
            
            log(`ðŸ“± getDisplayMedia support: ${hasGetDisplayMedia}`, hasGetDisplayMedia ? 'success' : 'error');
            log(`ðŸ“± getUserMedia support: ${hasGetUserMedia}`, hasGetUserMedia ? 'success' : 'error');
            log(`ðŸŽµ AudioContext support: ${hasAudioContext}`, hasAudioContext ? 'success' : 'error');
            
            // 4. Permissions Check
            if (navigator.permissions) {
                try {
                    const micPermission = await navigator.permissions.query({name: 'microphone'});
                    log(`ðŸŽ¤ Microphone permission: ${micPermission.state}`, 
                        micPermission.state === 'granted' ? 'success' : 'warning');
                } catch (e) {
                    log(`ðŸŽ¤ Microphone permission check failed: ${e.message}`, 'warning');
                }
                
                try {
                    const displayPermission = await navigator.permissions.query({name: 'display-capture'});
                    log(`ðŸ–¥ï¸ Display capture permission: ${displayPermission.state}`, 
                        displayPermission.state === 'granted' ? 'success' : 'warning');
                } catch (e) {
                    log(`ðŸ–¥ï¸ Display capture permission check failed: ${e.message}`, 'warning');
                }
            } else {
                log('âš ï¸ Permissions API not available', 'warning');
            }
            
            // 5. Feature Detection
            if (hasGetDisplayMedia) {
                log('âœ… getDisplayMedia is available - system audio should work', 'success');
            } else {
                log('âŒ getDisplayMedia not available - system audio will not work', 'error');
            }
            
            // 6. Recommendations
            log('ðŸ“‹ Diagnostic Summary:', 'info');
            if (!isChrome) {
                log('ðŸ’¡ Recommendation: Use Chrome or Edge for best system audio support', 'warning');
            }
            if (!isHTTPS && !isLocalhost && !isFile) {
                log('ðŸ’¡ Recommendation: Use HTTPS or localhost for system audio', 'warning');
            }
            if (isFile) {
                log('ðŸ’¡ Recommendation: Run from a web server instead of opening file directly', 'warning');
            }
            if (hasGetDisplayMedia) {
                log('âœ… System audio should work - try the test button!', 'success');
            } else {
                log('âŒ System audio will not work - use microphone instead', 'error');
            }
        }

        async function testSystemAudio() {
            log('ðŸŽµ Testing system audio capture...', 'info');
            
            if (!navigator.mediaDevices || !navigator.mediaDevices.getDisplayMedia) {
                log('âŒ getDisplayMedia not supported', 'error');
                return;
            }
            
            try {
                log('ðŸ“± Requesting display media with audio...', 'info');
                log('ðŸ’¡ In the dialog: Select your screen and CHECK "Share system audio"', 'warning');
                
                const stream = await navigator.mediaDevices.getDisplayMedia({
                    video: false,
                    audio: {
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false
                    }
                });
                
                log('âœ… Display media stream obtained!', 'success');
                
                const audioTracks = stream.getAudioTracks();
                log(`ðŸŽµ Audio tracks found: ${audioTracks.length}`, audioTracks.length > 0 ? 'success' : 'error');
                
                if (audioTracks.length === 0) {
                    log('âŒ No audio tracks - make sure "Share system audio" was checked', 'error');
                    log('ðŸ’¡ Try again and ensure the "Share system audio" checkbox is selected', 'warning');
                } else {
                    log('âœ… System audio capture successful!', 'success');
                    audioTracks.forEach((track, index) => {
                        log(`ðŸŽµ Track ${index}: ${track.label || 'Unnamed'} (${track.kind})`, 'info');
                    });
                    
                    // Test audio analysis
                    await testAudioAnalysis(stream, 'system');
                }
                
                // Clean up
                stream.getTracks().forEach(track => track.stop());
                
            } catch (error) {
                log(`âŒ System audio test failed: ${error.name} - ${error.message}`, 'error');
                
                if (error.name === 'NotAllowedError') {
                    log('ðŸ’¡ Permission denied - user cancelled or denied access', 'warning');
                } else if (error.name === 'NotSupportedError') {
                    log('ðŸ’¡ System audio not supported in this browser/context', 'warning');
                } else if (error.name === 'NotFoundError') {
                    log('ðŸ’¡ No audio source available for capture', 'warning');
                }
            }
        }

        async function testMicrophone() {
            log('ðŸŽ¤ Testing microphone capture...', 'info');
            
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                log('âŒ getUserMedia not supported', 'error');
                return;
            }
            
            try {
                log('ðŸ“± Requesting microphone access...', 'info');
                
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false
                    }
                });
                
                log('âœ… Microphone stream obtained!', 'success');
                
                const audioTracks = stream.getAudioTracks();
                log(`ðŸŽ¤ Audio tracks found: ${audioTracks.length}`, 'success');
                
                audioTracks.forEach((track, index) => {
                    log(`ðŸŽ¤ Track ${index}: ${track.label || 'Unnamed'} (${track.kind})`, 'info');
                });
                
                // Test audio analysis
                await testAudioAnalysis(stream, 'microphone');
                
                // Clean up
                stream.getTracks().forEach(track => track.stop());
                
            } catch (error) {
                log(`âŒ Microphone test failed: ${error.name} - ${error.message}`, 'error');
                
                if (error.name === 'NotAllowedError') {
                    log('ðŸ’¡ Microphone permission denied', 'warning');
                } else if (error.name === 'NotFoundError') {
                    log('ðŸ’¡ No microphone found', 'warning');
                }
            }
        }

        async function testAudioAnalysis(stream, sourceType) {
            log(`ðŸ”¬ Testing audio analysis with ${sourceType}...`, 'info');
            
            try {
                const AudioContextClass = window.AudioContext || window.webkitAudioContext;
                const audioContext = new AudioContextClass();
                
                if (audioContext.state === 'suspended') {
                    await audioContext.resume();
                }
                
                const analyser = audioContext.createAnalyser();
                analyser.fftSize = 1024;
                
                const source = audioContext.createMediaStreamSource(stream);
                source.connect(analyser);
                
                const dataArray = new Uint8Array(analyser.frequencyBinCount);
                
                log('ðŸŽµ Audio analysis setup complete', 'success');
                log('ðŸŽµ Play some music to test audio detection...', 'info');
                
                // Test for 5 seconds
                let testCount = 0;
                const testInterval = setInterval(() => {
                    analyser.getByteFrequencyData(dataArray);
                    
                    let sum = 0;
                    for (let i = 0; i < dataArray.length; i++) {
                        sum += dataArray[i];
                    }
                    const average = sum / dataArray.length;
                    const normalized = average / 255;
                    
                    if (normalized > 0.01) {
                        log(`ðŸŽµ Audio detected! Level: ${normalized.toFixed(3)}`, 'success');
                    } else if (testCount % 10 === 0) { // Every 2 seconds
                        log(`âšª Audio level: ${normalized.toFixed(3)} (play music to test)`, 'info');
                    }
                    
                    testCount++;
                    if (testCount >= 25) { // 5 seconds
                        clearInterval(testInterval);
                        audioContext.close();
                        log(`âœ… Audio analysis test complete for ${sourceType}`, 'success');
                    }
                }, 200);
                
            } catch (error) {
                log(`âŒ Audio analysis test failed: ${error.message}`, 'error');
            }
        }

        // Auto-run diagnostics on load
        window.addEventListener('load', () => {
            log('ðŸš€ System Audio Debug Tool loaded', 'info');
            log('ðŸ’¡ Click "Run Full Diagnostics" to check your system', 'info');
        });
    </script>
</body>
</html>